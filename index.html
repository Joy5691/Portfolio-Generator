<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Generator</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- jsPDF library for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        /* ========================================
           Black & Off-White Theme - Professional Portfolio
           ======================================== */

        :root {
            --black: #1a1a1a;
            --dark-gray: #2d2d2d;
            --medium-gray: #4a4a4a;
            --light-gray: #a0a0a0;
            --off-white: #f5f5f0;
            --white: #ffffff;
            --accent: #000000;
            --shadow: rgba(0, 0, 0, 0.15);
            --shadow-hover: rgba(0, 0, 0, 0.25);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--off-white) 0%, #e8e8e0 100%);
            min-height: 100vh;
            color: var(--black);
            line-height: 1.6;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        /* ========================================
           Header Styles
           ======================================== */

        .header {
            text-align: center;
            padding: 40px 20px;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.8rem;
            color: var(--black);
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px var(--shadow);
            animation: fadeInDown 0.8s ease-out;
        }

        .header p {
            font-size: 1.2rem;
            color: var(--medium-gray);
            animation: fadeInUp 0.8s ease-out;
        }

        /* ========================================
           Section Visibility
           ======================================== */

        .section {
            display: none;
        }

        .section.active {
            display: block;
            animation: fadeIn 0.5s ease-out;
        }

        /* ========================================
           Auth Form Container
           ======================================== */

        .auth-container {
            background: white;
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 10px 30px var(--shadow);
            max-width: 500px;
            margin: 0 auto;
            animation: slideUp 0.6s ease-out;
        }

        .auth-container h2 {
            font-size: 1.8rem;
            color: var(--black);
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* ========================================
           Form Container Styles
           ======================================== */

        .form-container {
            background: white;
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 10px 30px var(--shadow);
            margin-bottom: 30px;
            animation: fadeIn 1s ease-out;
        }

        .form-section {
            margin-bottom: 35px;
        }

        .form-section h2 {
            font-size: 1.5rem;
            color: var(--black);
            margin-bottom: 20px;
            border-bottom: 2px solid var(--black);
            padding-bottom: 10px;
        }

        /* ========================================
           Input Styles
           ======================================== */

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--dark-gray);
            font-weight: 500;
            font-size: 0.95rem;
        }

        .input-group input,
        .input-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background-color: var(--off-white);
            color: var(--black);
        }

        .input-group input:focus,
        .input-group textarea:focus {
            outline: none;
            border-color: var(--black);
            background-color: var(--white);
            box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .input-group textarea {
            min-height: 100px;
            resize: vertical;
            font-family: inherit;
        }

        /* ========================================
           Dynamic Fields Styles
           ======================================== */

        .dynamic-field {
            background: var(--off-white);
            padding: 20px;
            padding-top: 40px;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 2px solid #e0e0e0;
            position: relative;
            animation: slideIn 0.3s ease-out;
        }

        .dynamic-field-header {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 10px;
        }

        .remove-btn {
            background: #cc0000;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .remove-btn:hover {
            background: #990000;
            transform: rotate(90deg) scale(1.1);
        }

        /* ========================================
           Button Styles
           ======================================== */

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: var(--black);
            color: white;
            box-shadow: 0 4px 15px var(--shadow);
        }

        .btn-primary:hover {
            background: var(--dark-gray);
            box-shadow: 0 6px 20px var(--shadow-hover);
            transform: translateY(-2px);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: var(--medium-gray);
            color: white;
            margin-left: 10px;
        }

        .btn-secondary:hover {
            background: var(--dark-gray);
            transform: translateY(-2px);
        }

        .add-btn {
            background: var(--off-white);
            color: var(--black);
            border: 2px solid var(--black);
            margin-top: 10px;
        }

        .add-btn:hover {
            background: var(--black);
            color: white;
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        /* ========================================
           Toggle Text Link
           ======================================== */

        .toggle-text {
            text-align: center;
            margin-top: 20px;
            color: var(--medium-gray);
        }

        .toggle-text a {
            color: var(--black);
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .toggle-text a:hover {
            color: var(--dark-gray);
            text-decoration: underline;
        }

        /* ========================================
           Error/Success Messages
           ======================================== */

        .message {
            padding: 12px 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            animation: slideDown 0.3s ease-out;
        }

        .message.error {
            background: #fee;
            color: #c33;
            border: 2px solid #fcc;
        }

        .message.success {
            background: #efe;
            color: #3c3;
            border: 2px solid #cfc;
        }

        /* ========================================
           Loading Spinner
           ======================================== */

        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
        }

        /* ========================================
           Preview Container Styles
           ======================================== */

        .preview-container {
            background: white;
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 10px 30px var(--shadow);
            display: none;
            animation: fadeIn 0.5s ease-out;
        }

        .preview-container.active {
            display: block;
        }

        .preview-header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 3px solid var(--black);
        }

        .preview-header h1 {
            font-size: 2.5rem;
            color: var(--black);
            margin-bottom: 5px;
        }

        .preview-header .contact-info {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 15px;
            color: var(--medium-gray);
        }

        .contact-info span {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .preview-section {
            margin-bottom: 30px;
        }

        .preview-section h2 {
            font-size: 1.8rem;
            color: var(--black);
            margin-bottom: 15px;
            border-bottom: 2px solid var(--black);
            padding-bottom: 8px;
        }

        .preview-item {
            margin-bottom: 20px;
            padding-left: 15px;
        }

        .preview-item h3 {
            font-size: 1.3rem;
            color: var(--dark-gray);
            margin-bottom: 5px;
        }

        .preview-item .date {
            color: var(--light-gray);
            font-style: italic;
            margin-bottom: 8px;
        }

        .preview-item p {
            color: var(--medium-gray);
            line-height: 1.6;
        }

        .skills-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .skill-tag {
            background: var(--black);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
        }

        /* ========================================
           Animations
           ======================================== */

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(40px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
                transform: scale(1);
            }
            to {
                opacity: 0;
                transform: scale(0.8);
            }
        }

        /* ========================================
           Responsive Design
           ======================================== */

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }

            .form-container,
            .preview-container,
            .auth-container {
                padding: 20px;
            }

            .contact-info {
                flex-direction: column;
                align-items: center;
            }

            .btn {
                width: 100%;
                margin: 5px 0;
            }

            .btn-secondary {
                margin-left: 0;
            }
        }

        /* ========================================
           Utility Classes
           ======================================== */

        .text-center {
            text-align: center;
        }

        .mt-20 {
            margin-top: 20px;
        }

        .mb-20 {
            margin-bottom: 20px;
        }

        .hidden {
            display: none !important;
        }

        .row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        @media (max-width: 768px) {
            .row {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1><i class="fas fa-briefcase"></i> Portfolio Generator</h1>
            <p>Create Your Professional Portfolio</p>
        </div>

        <!-- Login Section -->
        <div id="loginSection" class="section active">
            <div class="auth-container">
                <form id="loginForm">
                    <h2><i class="fas fa-user-circle"></i> Login</h2>
                    <div id="loginMessage"></div>

                    <div class="input-group">
                        <label for="loginEmail"><i class="fas fa-envelope"></i> Email</label>
                        <input type="email" id="loginEmail" placeholder="your.email@example.com" required>
                    </div>

                    <div class="input-group">
                        <label for="loginPassword"><i class="fas fa-lock"></i> Password</label>
                        <input type="password" id="loginPassword" placeholder="••••••••" required>
                    </div>

                    <button type="submit" class="btn btn-primary" style="width: 100%;" id="loginBtn">
                        <i class="fas fa-arrow-right"></i> Login
                    </button>
                </form>

                <div class="toggle-text">
                    Don't have an account? <a href="#" id="showRegister">Create Account</a>
                </div>
            </div>
        </div>

        <!-- Register Section -->
        <div id="registerSection" class="section">
            <div class="auth-container">
                <form id="registerForm">
                    <h2><i class="fas fa-user-plus"></i> Create Account</h2>
                    <div id="registerMessage"></div>

                    <div class="input-group">
                        <label for="registerEmail"><i class="fas fa-envelope"></i> Email</label>
                        <input type="email" id="registerEmail" placeholder="your.email@example.com" required>
                    </div>

                    <div class="input-group">
                        <label for="registerPassword"><i class="fas fa-lock"></i> Password</label>
                        <input type="password" id="registerPassword" placeholder="••••••••" minlength="6" required>
                    </div>

                    <div class="input-group">
                        <label for="registerPasswordConfirm"><i class="fas fa-lock"></i> Confirm Password</label>
                        <input type="password" id="registerPasswordConfirm" placeholder="••••••••" minlength="6" required>
                    </div>

                    <button type="submit" class="btn btn-primary" style="width: 100%;" id="registerBtn">
                        <i class="fas fa-user-plus"></i> Create Account
                    </button>
                </form>

                <div class="toggle-text">
                    Already have an account? <a href="#" id="showLogin">Login</a>
                </div>
            </div>
        </div>

        <!-- Portfolio Builder Section -->
        <div id="builderSection" class="section">
            <div class="form-container">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap; gap: 10px;">
                    <h2 style="margin: 0;"><i class="fas fa-edit"></i> Build Your Portfolio</h2>
                    <div>
                        <button type="button" class="btn btn-secondary" onclick="saveProgress()" style="margin: 0 5px;">
                            <i class="fas fa-save"></i> Save Progress
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </div>
                </div>

                <form id="portfolioForm">
                    <!-- Personal Information Section -->
                    <div class="form-section">
                        <h2><i class="fas fa-user"></i> Personal Information</h2>
                        <div class="input-group">
                            <label for="fullName">Full Name *</label>
                            <input type="text" id="fullName" placeholder="Enter your full name" required>
                        </div>
                        <div class="row">
                            <div class="input-group">
                                <label for="email">Email *</label>
                                <input type="email" id="email" placeholder="your.email@example.com" required>
                            </div>
                            <div class="input-group">
                                <label for="phone">Phone *</label>
                                <input type="tel" id="phone" placeholder="+1234567890" required>
                            </div>
                        </div>
                        <div class="input-group">
                            <label for="profilePhoto">Profile Photo (JPG/PNG) *</label>
                            <input type="file" id="profilePhoto" accept="image/*" required>
                        </div>
                        <div class="input-group">
                            <label for="shortBio">Short Bio *</label>
                            <textarea id="shortBio" placeholder="Tell us about yourself in a few sentences..." required></textarea>
                        </div>
                    </div>

                    <!-- Skills Section -->
                    <div class="form-section">
                        <h2><i class="fas fa-tools"></i> Skills</h2>
                        <div class="input-group">
                            <label for="softSkills">Soft Skills *</label>
                            <textarea id="softSkills" placeholder="e.g., Communication, Leadership, Problem Solving..." required></textarea>
                        </div>
                        <div class="input-group">
                            <label for="technicalSkills">Technical Skills *</label>
                            <textarea id="technicalSkills" placeholder="e.g., JavaScript, Python, React, Node.js..." required></textarea>
                        </div>
                    </div>

                    <!-- Academic Background Section (Multiple) -->
                    <div class="form-section">
                        <h2><i class="fas fa-graduation-cap"></i> Academic Background</h2>
                        <div id="academicContainer"></div>
                        <button type="button" class="btn add-btn" onclick="addAcademic()">
                            <i class="fas fa-plus"></i> Add Academic Background
                        </button>
                    </div>

                    <!-- Work Experience Section -->
                    <div class="form-section">
                        <h2><i class="fas fa-briefcase"></i> Work Experience *</h2>
                        <div class="input-group">
                            <label for="companyName">Company Name *</label>
                            <input type="text" id="companyName" placeholder="Company name" required>
                        </div>
                        <div class="row">
                            <div class="input-group">
                                <label for="jobDuration">Job Duration *</label>
                                <input type="text" id="jobDuration" placeholder="e.g., Jan 2022 - Present" required>
                            </div>
                            <div class="input-group">
                                <label for="jobTitle">Job Title *</label>
                                <input type="text" id="jobTitle" placeholder="e.g., Software Developer" required>
                            </div>
                        </div>
                        <div class="input-group">
                            <label for="jobResponsibilities">Job Responsibilities *</label>
                            <textarea id="jobResponsibilities" placeholder="Describe your key responsibilities and achievements..." required></textarea>
                        </div>
                    </div>

                    <!-- Projects Section (Multiple) -->
                    <div class="form-section">
                        <h2><i class="fas fa-project-diagram"></i> Projects/Publications</h2>
                        <div id="projectsContainer"></div>
                        <button type="button" class="btn add-btn" onclick="addProject()">
                            <i class="fas fa-plus"></i> Add Project
                        </button>
                    </div>

                    <!-- Submit Buttons -->
                    <div class="text-center mt-20">
                        <button type="submit" class="btn btn-primary" id="generateBtn">
                            <i class="fas fa-rocket"></i> Generate Portfolio
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="resetForm()">
                            <i class="fas fa-redo"></i> Reset Form
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Preview Container -->
        <div class="preview-container" id="previewContainer">
            <div id="portfolioPreview"></div>
            <div class="text-center mt-20">
                <button type="button" class="btn btn-primary" onclick="downloadPDF()">
                    <i class="fas fa-download"></i> Download PDF
                </button>
                <button type="button" class="btn btn-secondary" onclick="hidePreview()">
                    <i class="fas fa-edit"></i> Edit Portfolio
                </button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, fetchSignInMethodsForEmail } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBI1MTT13cQQIVgFqdLGiRtjRzNHVv0UUQ",
            authDomain: "portfolio-generator-f1fc3.firebaseapp.com",
            projectId: "portfolio-generator-f1fc3",
            storageBucket: "portfolio-generator-f1fc3.firebasestorage.app",
            messagingSenderId: "1071355580668",
            appId: "1:1071355580668:web:1894ed04c2a7ad6ac9c779",
            measurementId: "G-FSDQ54621J"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        console.log("Firebase initialized successfully");

        // Make services available globally
        window.firebaseAuth = auth;
        window.firebaseDB = db;
        window.fetchSignInMethods = fetchSignInMethodsForEmail;

        // Auth state observer
        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log("User logged in:", user.email);
                showSection('builderSection');
                loadUserData(user.uid);
            } else {
                console.log("User logged out");
                showSection('loginSection');
            }
        });

        // Login form handler
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            const loginBtn = document.getElementById('loginBtn');
            const messageDiv = document.getElementById('loginMessage');

            try {
                loginBtn.disabled = true;
                loginBtn.innerHTML = '<span class="spinner"></span> Logging in...';
                messageDiv.innerHTML = '';

                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                console.log("Login successful:", userCredential.user.email);

                messageDiv.innerHTML = '<div class="message success"><i class="fas fa-check-circle"></i> Login successful! Redirecting...</div>';

            } catch (error) {
                console.error("Login error:", error);
                let errorMessage = 'Login failed. Please check your credentials.';

                if (error.code === 'auth/user-not-found') {
                    errorMessage = 'No account found with this email. Please create an account first.';
                } else if (error.code === 'auth/wrong-password') {
                    errorMessage = 'Incorrect password. Please try again.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Invalid email address format.';
                } else if (error.code === 'auth/too-many-requests') {
                    errorMessage = 'Too many failed attempts. Please try again later.';
                } else if (error.code === 'auth/invalid-credential') {
                    errorMessage = 'Invalid credentials. Please check your email and password.';
                }

                messageDiv.innerHTML = `<div class="message error"><i class="fas fa-exclamation-circle"></i> ${errorMessage}</div>`;
            } finally {
                loginBtn.disabled = false;
                loginBtn.innerHTML = '<i class="fas fa-arrow-right"></i> Login';
            }
        });

        // Register form handler with duplicate email check
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('registerEmail').value.trim();
            const password = document.getElementById('registerPassword').value;
            const passwordConfirm = document.getElementById('registerPasswordConfirm').value;
            const registerBtn = document.getElementById('registerBtn');
            const messageDiv = document.getElementById('registerMessage');

            if (password !== passwordConfirm) {
                messageDiv.innerHTML = '<div class="message error"><i class="fas fa-exclamation-circle"></i> Passwords do not match!</div>';
                return;
            }

            if (password.length < 6) {
                messageDiv.innerHTML = '<div class="message error"><i class="fas fa-exclamation-circle"></i> Password must be at least 6 characters!</div>';
                return;
            }

            try {
                registerBtn.disabled = true;
                registerBtn.innerHTML = '<span class="spinner"></span> Creating account...';
                messageDiv.innerHTML = '';

                // Check if email already exists
                const signInMethods = await fetchSignInMethodsForEmail(auth, email);
                if (signInMethods.length > 0) {
                    messageDiv.innerHTML = '<div class="message error"><i class="fas fa-exclamation-circle"></i> An account with this email address already exists. Please login instead.</div>';
                    registerBtn.disabled = false;
                    registerBtn.innerHTML = '<i class="fas fa-user-plus"></i> Create Account';
                    return;
                }

                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                console.log("Registration successful:", userCredential.user.email);

                messageDiv.innerHTML = '<div class="message success"><i class="fas fa-check-circle"></i> Account created successfully! Redirecting...</div>';

                setTimeout(() => {
                    showSection('builderSection');
                }, 1500);

            } catch (error) {
                console.error("Registration error:", error);
                let errorMessage = 'Registration failed. Please try again.';

                if (error.code === 'auth/email-already-in-use') {
                    errorMessage = 'An account with this email address already exists. Please login instead.';
                } else if (error.code === 'auth/invalid-email') {
                    errorMessage = 'Invalid email address format.';
                } else if (error.code === 'auth/weak-password') {
                    errorMessage = 'Password is too weak. Use at least 6 characters with numbers and symbols.';
                }

                messageDiv.innerHTML = `<div class="message error"><i class="fas fa-exclamation-circle"></i> ${errorMessage}</div>`;
            } finally {
                registerBtn.disabled = false;
                registerBtn.innerHTML = '<i class="fas fa-user-plus"></i> Create Account';
            }
        });

        // Load user data from Firestore
        async function loadUserData(uid) {
            try {
                const docRef = doc(db, "portfolios", uid);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const data = docSnap.data();
                    console.log("Loaded saved portfolio data");

                    // Populate basic fields
                    if (data.fullName) document.getElementById('fullName').value = data.fullName;
                    if (data.email) document.getElementById('email').value = data.email;
                    if (data.phone) document.getElementById('phone').value = data.phone;
                    if (data.shortBio) document.getElementById('shortBio').value = data.shortBio;
                    if (data.softSkills) document.getElementById('softSkills').value = data.softSkills;
                    if (data.technicalSkills) document.getElementById('technicalSkills').value = data.technicalSkills;
                    if (data.companyName) document.getElementById('companyName').value = data.companyName;
                    if (data.jobDuration) document.getElementById('jobDuration').value = data.jobDuration;
                    if (data.jobTitle) document.getElementById('jobTitle').value = data.jobTitle;
                    if (data.jobResponsibilities) document.getElementById('jobResponsibilities').value = data.jobResponsibilities;

                    // Load multiple academic backgrounds
                    if (data.academics && Array.isArray(data.academics)) {
                        data.academics.forEach(academic => {
                            addAcademic(academic);
                        });
                    }

                    // Load multiple projects
                    if (data.projects && Array.isArray(data.projects)) {
                        data.projects.forEach(project => {
                            addProject(project);
                        });
                    }
                } else {
                    console.log("No saved data found");
                }
            } catch (error) {
                console.error("Error loading user data:", error);
                // Don't show error to user, just log it
            }
        }

        // Make logout available globally
        window.logout = async function() {
            if (confirm('Are you sure you want to logout?')) {
                try {
                    await signOut(auth);
                    console.log("Logout successful");
                } catch (error) {
                    console.error("Logout error:", error);
                    alert("Error logging out. Please try again.");
                }
            }
        };

        // Save progress function with better error handling
        window.saveProgress = async function() {
            try {
                const user = auth.currentUser;
                if (!user) {
                    alert("Please login first");
                    return;
                }

                const formData = collectFormData();
                const docRef = doc(db, "portfolios", user.uid);
                await setDoc(docRef, formData);

                alert("Portfolio progress saved successfully!");
                console.log("Progress saved to Firestore");
            } catch (error) {
                console.error("Error saving progress:", error);
                // Even if Firestore fails, don't block the user
                console.log("Continuing without save - Firestore may not be configured");
            }
        };
    </script>

    <!-- Main Application JavaScript -->
    <script>
        // Dynamic field counters
        let academicCount = 0;
        let projectCount = 0;

        // Section management
        function showSection(sectionId) {
            const sections = document.querySelectorAll('.section');
            sections.forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');
        }

        // Toggle between login and register
        document.getElementById('showRegister').addEventListener('click', (e) => {
            e.preventDefault();
            showSection('registerSection');
        });

        document.getElementById('showLogin').addEventListener('click', (e) => {
            e.preventDefault();
            showSection('loginSection');
        });

        // Add Academic Background field
        window.addAcademic = function(data = null) {
            academicCount++;
            const container = document.getElementById('academicContainer');
            const div = document.createElement('div');
            div.className = 'dynamic-field';
            div.id = `academic-${academicCount}`;
            div.innerHTML = `
                <div class="dynamic-field-header">
                    <button type="button" class="remove-btn" onclick="removeField('academic-${academicCount}')">×</button>
                </div>
                <div class="input-group">
                    <label>Institute</label>
                    <input type="text" class="academic-institute" placeholder="University/College name" value="${data?.institute || ''}">
                </div>
                <div class="input-group">
                    <label>Degree</label>
                    <input type="text" class="academic-degree" placeholder="e.g., Bachelor of Science" value="${data?.degree || ''}">
                </div>
                <div class="row">
                    <div class="input-group">
                        <label>Year</label>
                        <input type="text" class="academic-year" placeholder="e.g., 2020-2024" value="${data?.year || ''}">
                    </div>
                    <div class="input-group">
                        <label>Grade/CGPA</label>
                        <input type="text" class="academic-grade" placeholder="e.g., 3.8/4.0" value="${data?.grade || ''}">
                    </div>
                </div>
            `;
            container.appendChild(div);
        };

        // Add Project field
        window.addProject = function(data = null) {
            projectCount++;
            const container = document.getElementById('projectsContainer');
            const div = document.createElement('div');
            div.className = 'dynamic-field';
            div.id = `project-${projectCount}`;
            div.innerHTML = `
                <div class="dynamic-field-header">
                    <button type="button" class="remove-btn" onclick="removeField('project-${projectCount}')">×</button>
                </div>
                <div class="input-group">
                    <label>Project Name</label>
                    <input type="text" class="project-name" placeholder="Project title" value="${data?.name || ''}">
                </div>
                <div class="input-group">
                    <label>Description</label>
                    <textarea class="project-description" placeholder="Describe the project...">${data?.description || ''}</textarea>
                </div>
                <div class="input-group">
                    <label>Technologies Used</label>
                    <input type="text" class="project-tech" placeholder="e.g., React, Node.js, MongoDB" value="${data?.technologies || ''}">
                </div>
            `;
            container.appendChild(div);
        };

        // Remove dynamic field
        window.removeField = function(fieldId) {
            const field = document.getElementById(fieldId);
            field.style.animation = 'fadeOut 0.3s ease-out';
            setTimeout(() => field.remove(), 300);
        };

        // Collect all form data
        function collectFormData() {
            // Collect academic backgrounds
            const academics = [];
            document.querySelectorAll('#academicContainer .dynamic-field').forEach(field => {
                const institute = field.querySelector('.academic-institute').value;
                if (institute) {
                    academics.push({
                        institute: institute,
                        degree: field.querySelector('.academic-degree').value,
                        year: field.querySelector('.academic-year').value,
                        grade: field.querySelector('.academic-grade').value
                    });
                }
            });

            // Collect projects
            const projects = [];
            document.querySelectorAll('#projectsContainer .dynamic-field').forEach(field => {
                const name = field.querySelector('.project-name').value;
                if (name) {
                    projects.push({
                        name: name,
                        description: field.querySelector('.project-description').value,
                        technologies: field.querySelector('.project-tech').value
                    });
                }
            });

            return {
                fullName: document.getElementById('fullName').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                shortBio: document.getElementById('shortBio').value,
                softSkills: document.getElementById('softSkills').value,
                technicalSkills: document.getElementById('technicalSkills').value,
                companyName: document.getElementById('companyName').value,
                jobDuration: document.getElementById('jobDuration').value,
                jobTitle: document.getElementById('jobTitle').value,
                jobResponsibilities: document.getElementById('jobResponsibilities').value,
                academics: academics,
                projects: projects,
                lastUpdated: new Date().toISOString()
            };
        }

        // Portfolio form submission with improved error handling
        document.getElementById('portfolioForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const generateBtn = document.getElementById('generateBtn');
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<span class="spinner"></span> Generating...';

            try {
                const formData = collectFormData();

                // Try to save to Firestore, but don't block if it fails
                try {
                    const user = window.firebaseAuth.currentUser;
                    if (user && window.firebaseDB) {
                        const docRef = doc(window.firebaseDB, "portfolios", user.uid);
                        await setDoc(docRef, formData);
                        console.log("Portfolio saved to Firestore");
                    }
                } catch (saveError) {
                    console.warn("Could not save to Firestore:", saveError);
                    // Continue anyway - user can still generate and download PDF
                }

                // Generate preview (this always works)
                generatePreview(formData);

            } catch (error) {
                console.error("Error generating portfolio:", error);
                alert("Error generating portfolio. Please try again.");
            } finally {
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<i class="fas fa-rocket"></i> Generate Portfolio';
            }
        });

        function generatePreview(data) {
            let html = `
                <div class="preview-header">
                    <h1>${data.fullName}</h1>
                    <div class="contact-info">
                        <span><i class="fas fa-envelope"></i> ${data.email}</span>
                        <span><i class="fas fa-phone"></i> ${data.phone}</span>
                    </div>
                </div>
            `;

            // About Me
            if (data.shortBio) {
                html += `
                    <div class="preview-section">
                        <h2>About Me</h2>
                        <p>${data.shortBio}</p>
                    </div>
                `;
            }

            // Skills
            if (data.softSkills || data.technicalSkills) {
                html += `<div class="preview-section"><h2>Skills</h2>`;

                if (data.softSkills) {
                    html += `<h3 style="margin-top: 15px; color: var(--medium-gray); font-size: 1.2rem;">Soft Skills</h3>`;
                    const softSkillsArray = data.softSkills.split(',').map(s => s.trim());
                    html += `<div class="skills-list">
                        ${softSkillsArray.map(skill => `<span class="skill-tag">${skill}</span>`).join('')}
                    </div>`;
                }

                if (data.technicalSkills) {
                    html += `<h3 style="margin-top: 15px; color: var(--medium-gray); font-size: 1.2rem;">Technical Skills</h3>`;
                    const techSkillsArray = data.technicalSkills.split(',').map(s => s.trim());
                    html += `<div class="skills-list">
                        ${techSkillsArray.map(skill => `<span class="skill-tag">${skill}</span>`).join('')}
                    </div>`;
                }

                html += `</div>`;
            }

            // Academic Backgrounds (Multiple)
            if (data.academics && data.academics.length > 0) {
                html += `<div class="preview-section"><h2>Education</h2>`;
                data.academics.forEach(academic => {
                    html += `
                        <div class="preview-item">
                            <h3>${academic.degree}</h3>
                            <p><strong>${academic.institute}</strong></p>
                            <div class="date">${academic.year}</div>
                            ${academic.grade ? `<p>Grade: ${academic.grade}</p>` : ''}
                        </div>
                    `;
                });
                html += `</div>`;
            }

            // Work Experience
            if (data.companyName) {
                html += `
                    <div class="preview-section">
                        <h2>Work Experience</h2>
                        <div class="preview-item">
                            <h3>${data.jobTitle}</h3>
                            <p><strong>${data.companyName}</strong></p>
                            <div class="date">${data.jobDuration}</div>
                            <p>${data.jobResponsibilities}</p>
                        </div>
                    </div>
                `;
            }

            // Projects (Multiple)
            if (data.projects && data.projects.length > 0) {
                html += `<div class="preview-section"><h2>Projects & Publications</h2>`;
                data.projects.forEach(project => {
                    html += `
                        <div class="preview-item">
                            <h3>${project.name}</h3>
                            <p>${project.description}</p>
                            ${project.technologies ? `<p><strong>Technologies:</strong> ${project.technologies}</p>` : ''}
                        </div>
                    `;
                });
                html += `</div>`;
            }

            document.getElementById('portfolioPreview').innerHTML = html;
            document.getElementById('previewContainer').classList.add('active');
            document.getElementById('previewContainer').scrollIntoView({ behavior: 'smooth' });
        }

        function hidePreview() {
            document.getElementById('previewContainer').classList.remove('active');
            document.querySelector('.form-container').scrollIntoView({ behavior: 'smooth' });
        }

        window.resetForm = function() {
            if (confirm('Are you sure you want to reset the form? All unsaved data will be lost.')) {
                document.getElementById('portfolioForm').reset();
                document.getElementById('academicContainer').innerHTML = '';
                document.getElementById('projectsContainer').innerHTML = '';
                academicCount = 0;
                projectCount = 0;
                hidePreview();
            }
        };

        // PDF Generation
        window.downloadPDF = function() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            const formData = collectFormData();

            let yPosition = 20;

            // Header
            doc.setFontSize(22);
            doc.setFont(undefined, 'bold');
            doc.text(formData.fullName, 105, yPosition, { align: 'center' });
            yPosition += 8;

            // Contact Info
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`${formData.email} | ${formData.phone}`, 105, yPosition, { align: 'center' });
            yPosition += 10;

            // About Me
            if (formData.shortBio) {
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text('About Me', 20, yPosition);
                yPosition += 6;
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                const bioLines = doc.splitTextToSize(formData.shortBio, 170);
                doc.text(bioLines, 20, yPosition);
                yPosition += bioLines.length * 5 + 5;
            }

            // Skills
            if (formData.softSkills || formData.technicalSkills) {
                if (yPosition > 250) {
                    doc.addPage();
                    yPosition = 20;
                }
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text('Skills', 20, yPosition);
                yPosition += 6;
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');

                if (formData.softSkills) {
                    doc.text('Soft Skills: ' + formData.softSkills, 20, yPosition);
                    yPosition += 5;
                }

                if (formData.technicalSkills) {
                    doc.text('Technical Skills: ' + formData.technicalSkills, 20, yPosition);
                    yPosition += 5;
                }
                yPosition += 5;
            }

            // Education (Multiple)
            if (formData.academics && formData.academics.length > 0 && yPosition < 270) {
                if (yPosition > 240) {
                    doc.addPage();
                    yPosition = 20;
                }
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text('Education', 20, yPosition);
                yPosition += 6;

                formData.academics.forEach(academic => {
                    if (yPosition > 270) {
                        doc.addPage();
                        yPosition = 20;
                    }
                    doc.setFontSize(11);
                    doc.setFont(undefined, 'bold');
                    doc.text(academic.degree, 20, yPosition);
                    yPosition += 5;
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');
                    doc.text(`${academic.institute} - ${academic.year}`, 20, yPosition);
                    yPosition += 5;
                    if (academic.grade) {
                        doc.text(`Grade: ${academic.grade}`, 20, yPosition);
                        yPosition += 5;
                    }
                    yPosition += 3;
                });
                yPosition += 3;
            }

            // Work Experience
            if (formData.companyName && yPosition < 270) {
                if (yPosition > 230) {
                    doc.addPage();
                    yPosition = 20;
                }
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text('Work Experience', 20, yPosition);
                yPosition += 6;
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.text(formData.jobTitle, 20, yPosition);
                yPosition += 5;
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text(`${formData.companyName} - ${formData.jobDuration}`, 20, yPosition);
                yPosition += 5;
                const respLines = doc.splitTextToSize(formData.jobResponsibilities, 170);
                doc.text(respLines, 20, yPosition);
                yPosition += respLines.length * 5 + 5;
            }

            // Projects (Multiple)
            if (formData.projects && formData.projects.length > 0 && yPosition < 270) {
                if (yPosition > 230) {
                    doc.addPage();
                    yPosition = 20;
                }
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text('Projects & Publications', 20, yPosition);
                yPosition += 6;

                formData.projects.forEach(project => {
                    if (yPosition > 260) {
                        doc.addPage();
                        yPosition = 20;
                    }
                    doc.setFontSize(11);
                    doc.setFont(undefined, 'bold');
                    doc.text(project.name, 20, yPosition);
                    yPosition += 5;
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');
                    const descLines = doc.splitTextToSize(project.description, 170);
                    doc.text(descLines, 20, yPosition);
                    yPosition += descLines.length * 5;
                    if (project.technologies) {
                        doc.text(`Technologies: ${project.technologies}`, 20, yPosition);
                        yPosition += 5;
                    }
                    yPosition += 3;
                });
            }

            doc.save(`${formData.fullName.replace(/\s+/g, '_')}_Portfolio.pdf`);
        };
    </script>
</body>
</html>